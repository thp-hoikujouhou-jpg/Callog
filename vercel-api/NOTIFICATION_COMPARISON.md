# 🔔 通知システムの比較

## 方式1: Firestoreリアルタイムリスナー (現在の実装)

### **動作条件:**
- ✅ Callogアプリがアクティブ (画面に表示されている)
- ❌ 他のタブを見ている場合は動作しない
- ❌ ブラウザが最小化されている場合は動作しない

### **通知の表示:**
```
Callogアプリ内のダイアログ
┌─────────────────────────────────┐
│  音声通話着信                    │
│  ユーザー1さんから...           │
│  [拒否] [応答]                  │
└─────────────────────────────────┘
```

### **利点:**
- ✅ FCM不要
- ✅ Firebase Admin SDK不要
- ✅ 追加の環境変数不要
- ✅ シンプル

### **欠点:**
- ❌ アプリがアクティブな場合のみ
- ❌ バックグラウンドでは動作しない

---

## 方式2: FCM ブラウザ通知 (未実装)

### **動作条件:**
- ✅ Callogアプリがバックグラウンドでも動作
- ✅ 他のタブを見ていても通知表示
- ✅ ブラウザが最小化されていても通知表示

### **通知の表示:**
```
ブラウザ通知 (デスクトップ右下)
┌─────────────────────────────┐
│ 🔔 Callog                   │
│ 音声通話着信                 │
│ ユーザー1さんから...         │
└─────────────────────────────┘
```

### **利点:**
- ✅ バックグラウンドでも動作
- ✅ 他のタブを見ていても表示
- ✅ ブラウザ最小化でも表示

### **欠点:**
- ❌ FCM Server Key または Firebase Admin SDK が必要
- ❌ 組織ポリシーにより実装困難

---

## 🎯 推奨される使い方

### **現在の実装 (Firestoreリアルタイムリスナー) で十分な場合:**

**ユースケース:**
- 両者がアプリを開いている状態で通話
- ビデオ会議のように事前に時間を決めて通話
- チャット中に通話に切り替える

**使い方:**
1. ユーザー1とユーザー2がチャット
2. 「今から通話しましょう」とメッセージ
3. 両者がCallogアプリを開いている状態で通話開始
4. 着信ダイアログが表示される

---

### **FCM ブラウザ通知が必要な場合:**

**ユースケース:**
- 突然の着信 (相手が他のタブを見ている)
- ブラウザを最小化している相手への着信
- LINE/WhatsAppのような即座の通知が必要

**必要な実装:**
- Firebase Admin SDK または FCM Server Key
- Service Worker (バックグラウンド通知受信)
- FCM HTTP v1 API または Legacy API

---

## 🔧 FCM ブラウザ通知を追加するには

### **必要なもの:**
1. **Firebase Admin SDK 秘密鍵**
   - 組織ポリシーにより取得困難
   - または、組織ポリシーを無効化

2. **または、Web API Key (Legacy API用)**
   - Firebase Console → Project settings → Cloud Messaging
   - ただし、Legacy APIは2024年6月に廃止済み

### **実装手順:**
1. Firebase Admin SDK 秘密鍵を取得
2. Vercel環境変数に追加
3. FCM HTTP v1 APIを実装
4. Service Workerを実装 (Flutter Web)
5. ブラウザ通知権限をリクエスト

---

## 📊 まとめ

| 項目 | Firestoreリアルタイムリスナー | FCM ブラウザ通知 |
|------|------------------------------|------------------|
| **アプリアクティブ時** | ✅ 動作 | ✅ 動作 |
| **他のタブを見ている時** | ❌ 動作しない | ✅ 動作 |
| **ブラウザ最小化時** | ❌ 動作しない | ✅ 動作 |
| **FCM必要** | ❌ 不要 | ✅ 必要 |
| **Firebase Admin SDK必要** | ❌ 不要 | ✅ 必要 |
| **実装の複雑さ** | ⭐ 簡単 | ⭐⭐⭐ 複雑 |

---

## 🎯 推奨事項

### **現在の実装で十分な場合:**
- ✅ Firestoreリアルタイムリスナーを使用 (現在の実装)
- ✅ ユーザーに「通話前にアプリを開いておく」ことを案内
- ✅ チャット機能で通話の事前連絡を推奨

### **FCM ブラウザ通知が必要な場合:**
- Firebase Admin SDK 秘密鍵の取得方法を検討
- または、組織ポリシーの変更を検討
- 別の方法として、クライアント側のタブ管理 (Broadcast Channel API) も検討可能

---

## 💡 クライアント側の改善案 (FCM不要)

### **Broadcast Channel API を使用**

複数のタブ間で通信することで、他のタブでCallogを開いている場合に通知できます:

```javascript
// タブ間通信
const channel = new BroadcastChannel('callog_notifications');

// 着信を他のタブに通知
channel.postMessage({
  type: 'incoming_call',
  callerName: 'ユーザー1',
  channelId: 'call_xxx',
});

// 他のタブで受信
channel.onmessage = (event) => {
  if (event.data.type === 'incoming_call') {
    // 着信ダイアログを表示
  }
};
```

**利点:**
- ✅ FCM不要
- ✅ 複数のCallogタブ間で通知共有
- ❌ ブラウザが最小化されている場合は動作しない

---

## 🚀 次のステップ

1. **現在の実装をテスト**
   - 両方のブラウザでCallogを開いている状態で通話テスト
   
2. **動作確認**
   - アプリがアクティブな場合: 着信ダイアログ表示
   - 他のタブを見ている場合: 通知なし

3. **必要に応じて追加実装を検討**
   - FCM ブラウザ通知 (Firebase Admin SDK必要)
   - Broadcast Channel API (複数タブ間通信)

現在の実装で十分な場合は、追加の作業は不要です！
