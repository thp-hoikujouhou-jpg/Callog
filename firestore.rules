rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ✅ USERS Collection - Allow authenticated users to read and write their own data
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for friend list, search)
      allow read: if request.auth != null;
      // Users can only write to their own profile
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ✅ CONTACTS Collection
    match /contacts/{contactId} {
      allow read, write: if request.auth != null;
    }
    
    // ✅ CHATS Collection
    match /chats/{chatId} {
      // Users can read chats they are part of
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.user1Id ||
         request.auth.uid == resource.data.user2Id);
      // Anyone authenticated can create a chat
      allow create: if request.auth != null;
      // Users can update/delete chats they are part of
      allow update, delete: if request.auth != null &&
        (request.auth.uid == resource.data.user1Id ||
         request.auth.uid == resource.data.user2Id);
    }
    
    // ✅ MESSAGES Subcollection - CRITICAL FIX
    match /chats/{chatId}/messages/{messageId} {
      // Users can read messages in chats they are part of
      allow read: if request.auth != null &&
        (request.auth.uid == get(/databases/$(database)/documents/chats/$(chatId)).data.user1Id ||
         request.auth.uid == get(/databases/$(database)/documents/chats/$(chatId)).data.user2Id);
      
      // Users can create messages in chats they are part of
      allow create: if request.auth != null &&
        (request.auth.uid == get(/databases/$(database)/documents/chats/$(chatId)).data.user1Id ||
         request.auth.uid == get(/databases/$(database)/documents/chats/$(chatId)).data.user2Id);
      
      // ✅ CRITICAL: Allow sender OR receiver to update (for read receipts)
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.senderId ||
         request.auth.uid == resource.data.receiverId);
      
      // Only sender can delete their own messages
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.senderId;
    }
    
    // ✅ CALLS Collection
    match /calls/{callId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.callerId ||
         request.auth.uid == resource.data.calleeId);
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null &&
        (request.auth.uid == resource.data.callerId ||
         request.auth.uid == resource.data.calleeId);
    }
    
    // ✅ SIGNALING Subcollection
    match /calls/{callId}/signaling/{signalingId} {
      allow read, write: if request.auth != null;
    }
    
    // ✅ ICE CANDIDATES
    match /calls/{callId}/callerCandidates/{candidateId} {
      allow read, write: if request.auth != null;
    }
    
    match /calls/{callId}/calleeCandidates/{candidateId} {
      allow read, write: if request.auth != null;
    }
    
    // ✅ MISSED CALLS
    match /missed_calls/{missedCallId} {
      allow read, write: if request.auth != null;
    }
    
    // ✅ NOTIFICATION REQUESTS
    match /notification_requests/{notificationId} {
      allow read, write: if request.auth != null;
    }
    
    // ✅ CALL RECORDINGS (future feature)
    match /call_recordings/{recordingId} {
      allow read, write: if request.auth != null;
    }
    
    // ✅ MEETING NOTES (future feature)
    match /meeting_notes/{noteId} {
      allow read, write: if request.auth != null;
    }
  }
}
